# https://docs.docker.com/compose/compose-file/14-include/
#include:
#  - path:
    # - docker-compose.plex.yml
    # - docker-compose.jellyfin.yml
    # - docker-compose.emby.yml
    # - docker-compose.jellyseerr.yml

x-rclone-base: &rclone-base
  image: peterbuga/rclone-mount:latest
  restart: unless-stopped
  environment:
    TZ: ${TZ}
    PUID: ${PUID}
    PGID: ${PGID}
    RemotePath: "debridav:"
    MountPoint: "$DEBRIDAV_MOUNT_PATH_CONTAINERS"
    ConfigName: "rclone.conf"
    MountCommands: "--allow-other 
        --allow-non-empty 
        --vfs-cache-mode off 
        --rc-enable-metrics
        --metrics-addr :9002
        --low-level-retries=1
        --dir-cache-time=1s
        -vv
        "
  volumes:
    - ${DEBRIDAV_MOUNT_PATH_HOST_FS}:${DEBRIDAV_MOUNT_PATH_CONTAINERS}:rshared
    - ./rclone.conf:/config/rclone.conf
  cap_add:
    - SYS_ADMIN
  security_opt:
    - apparmor:unconfined
  devices:
    - /dev/fuse:/dev/fuse:rwm
  depends_on:
    debridav:
      condition: service_healthy


services:
  debridav:
    # build:
    #   context: ..
    image: ghcr.io/jtdevops/debridav:latest
    container_name: debridav
    hostname: debridav
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - DEBRIDAV_ROOT_PATH=${DEBRIDAV_ROOT_PATH}
      - DEBRIDAV_DOWNLOAD_PATH=${DEBRIDAV_DOWNLOAD_PATH}
      - DEBRIDAV_MOUNT_PATH=${DEBRIDAV_MOUNT_PATH_CONTAINERS}
      - DEBRIDAV_DEBRID_CLIENTS=${DEBRIDAV_DEBRID_CLIENTS}
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${DEBRIDAV_DB_HOST}:${DEBRIDAV_DB_PORT}/${DEBRIDAV_DB_DATABASE_NAME}?user=${DEBRIDAV_DB_USERNAME}&password=${DEBRIDAV_DB_PASSWORD}
      - PREMIUMIZE_API_KEY=${PREMIUMIZE_API_KEY}
      - REAL_DEBRID_API_KEY=${REAL_DEBRID_API_KEY}
      - SONARR_INTEGRATION_ENABLED=${SONARR_INTEGRATION_ENABLED}
      - SONARR_HOST=${SONARR_HOST}
      - SONARR_PORT=${SONARR_PORT}
      - SONARR_API_KEY=${SONARR_API_KEY}
      - RADARR_INTEGRATION_ENABLED=${RADARR_INTEGRATION_ENABLED}
      - RADARR_HOST=${RADARR_HOST}
      - RADARR_PORT=${RADARR_PORT}
      - RADARR_API_KEY=${RADARR_API_KEY}
      - EASYNEWS_USERNAME=${EASYNEWS_USERNAME}
      - EASYNEWS_PASSWORD=${EASYNEWS_PASSWORD}
      - TORBOX_API_KEY=${TORBOX_API_KEY}

      # IPTV Configuration
      # Enable IPTV support (default: false)
      - IPTV_ENABLED=${IPTV_ENABLED:-false}
      # Sync interval for IPTV content (default: PT24H - 24 hours)
      # Format: PT24H, PT12H, PT1H, etc.
      - IPTV_SYNC_INTERVAL=${IPTV_SYNC_INTERVAL:-PT24H}
      # Comma-separated list of IPTV provider names
      # Example: provider1,provider2,my-iptv-service
      # - IPTV_PROVIDERS=${IPTV_PROVIDERS:-}
      # - IPTV_PROVIDERS=provider1
      # - IPTV_PROVIDERS=provider2
      # - IPTV_PROVIDERS=provider1,provider2

      - IPTV_LANGUAGE_PREFIXES_INDEX_0="AM| "
      - IPTV_LANGUAGE_PREFIXES="007,4K-A+,4K-AMZ,4K-D+,4K-EN,4K-MAX,4K-MRVL,4K-NF,4K-NF-DO,4M-AMZ,A+,AMZ,CR,D+,D+ ,DWA,EN,EN-TOP,EX,MRVL,Nf,NF,NF-DO,NICK,P+,PCOK,PRMT,SHWT,SKY,TOP,TOP-DO,UFC,UNV,VP"

      - IPTV_METADATA_OMDB_API_KEY=${IPTV_METADATA_OMDB_API_KEY}
      - IPTV_INCLUDE_PROVIDER_IN_MAGNET_TITLE=true
      # IPTV Metadata Fetch Batch Size - Number of concurrent metadata fetch requests per batch (default: 5)
      - IPTV_METADATA_FETCH_BATCH_SIZE=${IPTV_METADATA_FETCH_BATCH_SIZE:-5}

      # - IPTV_USE_LOCAL_RESPONSES=true
      - IPTV_RESPONSE_SAVE_FOLDER=/iptv_cache

      - IPTV_PROVIDER_PROVIDER1_TYPE=xtream_codes
      - IPTV_PROVIDER_PROVIDER1_XTREAM_BASE_URL=${IPTV_PROVIDER_PROVIDER1_XTREAM_BASE_URL}
      - IPTV_PROVIDER_PROVIDER1_XTREAM_USERNAME=${IPTV_PROVIDER_PROVIDER1_XTREAM_USERNAME}
      - IPTV_PROVIDER_PROVIDER1_XTREAM_PASSWORD=${IPTV_PROVIDER_PROVIDER1_XTREAM_PASSWORD}
      - IPTV_PROVIDER_PROVIDER1_PRIORITY=1
      #- IPTV_PROVIDER_PROVIDER1_SYNC_ENABLED=true

      - IPTV_PROVIDER_PROVIDER2_TYPE=xtream_codes
      - IPTV_PROVIDER_PROVIDER2_XTREAM_BASE_URL=${IPTV_PROVIDER_PROVIDER2_XTREAM_BASE_URL}
      - IPTV_PROVIDER_PROVIDER2_XTREAM_USERNAME=${IPTV_PROVIDER_PROVIDER2_XTREAM_USERNAME}
      - IPTV_PROVIDER_PROVIDER2_XTREAM_PASSWORD=${IPTV_PROVIDER_PROVIDER2_XTREAM_PASSWORD}
      - IPTV_PROVIDER_PROVIDER2_PRIORITY=1
      #- IPTV_PROVIDER_PROVIDER2_SYNC_ENABLED=true

      # IPTV Provider Configuration
      # For each provider, configure the following (replace {PROVIDER_NAME} with your provider name):
      # Example for provider named "provider1":
      # - IPTV_PROVIDER_PROVIDER1_TYPE=m3u
      # - IPTV_PROVIDER_PROVIDER1_M3U_URL=https://example.com/playlist.m3u
      # OR for file-based M3U:
      # - IPTV_PROVIDER_PROVIDER1_TYPE=m3u
      # - IPTV_PROVIDER_PROVIDER1_M3U_FILE_PATH=/path/to/playlist.m3u
      # OR for Xtream Codes:
      # - IPTV_PROVIDER_PROVIDER1_TYPE=xtream_codes
      # - IPTV_PROVIDER_PROVIDER1_XTREAM_BASE_URL=https://example.com:8080
      # - IPTV_PROVIDER_PROVIDER1_XTREAM_USERNAME=user123
      # - IPTV_PROVIDER_PROVIDER1_XTREAM_PASSWORD=pass456
      # - IPTV_PROVIDER_PROVIDER1_PRIORITY=1

#      - LOGGING_LEVEL_WEB=debug
#      - LOGGING_LEVEL_IO_SKJAERE_DEBRIDAV=DEBUG
      # STRM Proxy Logging (set to DEBUG to see proxy URL processing steps)
      # - LOGGING_LEVEL_IO_SKJAERE_DEBRIDAV_RESOURCE_STRMREDIRECTPROXYCONTROLLER=DEBUG

      # IPTV Logging (set to DEBUG for detailed IPTV logs, INFO for normal operation)
      # Uncomment the lines below to enable IPTV-specific logging
#      - LOGGING_LEVEL_IO_SKJAERE_DEBRIDAV_IPTV=DEBUG
#      - LOGGING_LEVEL_IO_SKJAERE_DEBRIDAV_IPTV_IPTSYNCSERVICE=DEBUG
#      - LOGGING_LEVEL_IO_SKJAERE_DEBRIDAV_IPTV_IPTVREQUESTSERVICE=DEBUG
#      - LOGGING_LEVEL_IO_SKJAERE_DEBRIDAV_IPTV_IPTVCONTENTSERVICE=DEBUG
#      - LOGGING_LEVEL_IO_SKJAERE_DEBRIDAV_IPTV_API_IPTVAPICONTROLLER=DEBUG
#      - LOGGING_LEVEL_IO_SKJAERE_DEBRIDAV_IPTV_IPTVCONTROLLER=DEBUG
#      - LOGGING_LEVEL_IO_SKJAERE_DEBRIDAV_IPTV_PARSER_M3UPARSER=DEBUG
#      - LOGGING_LEVEL_IO_SKJAERE_DEBRIDAV_IPTV_CLIENT_XTREAMCODESCLIENT=DEBUG
#      - LOGGING_LEVEL_IO_SKJAERE_DEBRIDAV_IPTV_CONFIGURATION_IPTVCONFIGURATIONSERVICE=DEBUG
#      - LOGGING_LEVEL_IO_SKJAERE_DEBRIDAV_TORRENT_TORRENTSERVICE=DEBUG

      # IPTV Trace Logging: Enable TRACE level exception logging for IPTV streaming diagnostics
#      - LOGGING_LEVEL_IO_SKJAERE_DEBRIDAV=TRACE
#      - LOGGING_LEVEL_IO_SKJAERE_DEBRIDAV_STREAM=TRACE
#      - LOGGING_LEVEL_IO_SKJAERE_DEBRIDAV_STREAM_STREAMINGSERVICE=TRACE
#      - LOGGING_LEVEL_IO_SKJAERE_DEBRIDAV_DEBRID_CLIENT_DEFAULTSTREAMABLELINKPREPARER=TRACE

      # Download details can be accessed: http://<ip address>:8888/actuator/streaming-download-tracking
      - DEBRIDAV_ENABLE_STREAMING_DOWNLOAD_TRACKING=true
      # Disable the legacy import of .debridav files fom the /debridav container folder
      - DEBRIDAV_ENABLE_FILE_IMPORT_ON_STARTUP=false

      ### Buffer configuration options
      # For Default Behavior (5MB database caching)
      #- DEBRIDAV_ENABLE_CHUNK_CACHING=true
      #- DEBRIDAV_ENABLE_IN_MEMORY_BUFFERING=true
      ##- DEBRIDAV_CHUNK_CACHING_SIZE_THRESHOLD defaults to 5120000 (5MB)

      # 256KB In-Memory Buffer Only
      #- DEBRIDAV_ENABLE_CHUNK_CACHING=false
      #- DEBRIDAV_ENABLE_IN_MEMORY_BUFFERING=true
      #- DEBRIDAV_CHUNK_CACHING_SIZE_THRESHOLD=262144 # 256KB buffer

      # Complete Direct Streaming (No buffering)
      - DEBRIDAV_ENABLE_CHUNK_CACHING=false
      - DEBRIDAV_ENABLE_IN_MEMORY_BUFFERING=false
      ###

      # Streaming optimization
      - DEBRIDAV_STREAMING_DELAY_BETWEEN_RETRIES=50ms
      - DEBRIDAV_STREAMING_RETRIES_ON_PROVIDER_ERROR=2
      - DEBRIDAV_STREAMING_WAIT_AFTER_NETWORK_ERROR=100ms
      
      # Cache durations
      - DEBRIDAV_LINK_LIVENESS_CACHE_DURATION=15m
      - DEBRIDAV_CACHED_FILE_CACHE_DURATION=30m

      # Byte range chunking control - set to true to prevent aggressive chunking and caching
      - DEBRIDAV_DISABLE_BYTE_RANGE_REQUEST_CHUNKING=true

      #- DEBRIDAV_RCLONE_ARRS_USER_AGENT_PATTERN=rclone/arrs
      - DEBRIDAV_RCLONE_ARRS_HOSTNAME_PATTERN=rclone_arrs

      # Use a locally hosted video file for ARRS project requests
      - DEBRIDAV_ENABLE_RCLONE_ARRS_LOCAL_VIDEO=true
      - DEBRIDAV_RCLONE_ARRS_LOCAL_VIDEO_FILE_PATHS=1080p=/local-video/BigBuckBunny_60fps_1080p.mp4,720|=/local-video/BigBuckBunny_60fps_720p.mp4
#      - DEBRIDAV_RCLONE_ARRS_LOCAL_VIDEO_PATH_REGEX=^/downloads/.*
      - DEBRIDAV_RCLONE_ARRS_LOCAL_VIDEO_MIN_SIZE_KB=1024

      # Query the IPTV Provider directly for media details
      - DEBRIDAV_RCLONE_ARRS_LOCAL_VIDEO_FILE_IPTV_BYPASS_PROVIDERS=*

      # STRM Configuration
      - DEBRIDAV_STRM_ENABLED=false
      - DEBRIDAV_STRM_FOLDER_MAPPINGS=tv=tv_strm,movies=movies_strm
      - DEBRIDAV_STRM_ROOT_PATH_PREFIX=/data
      - DEBRIDAV_STRM_FILE_EXTENSION_MODE=REPLACE
      - DEBRIDAV_STRM_FILE_FILTER_MODE=MEDIA_ONLY
      - DEBRIDAV_STRM_MEDIA_EXTENSIONS=mkv,mp4,avi,mov,m4v
      # Optional: Control which providers use STRM files (default: * = all providers)
      # Examples:
      # - DEBRIDAV_STRM_PROVIDERS=*  # All providers use STRM files (default)
      # - DEBRIDAV_STRM_PROVIDERS=*,!IPTV  # All providers except IPTV use STRM files
      # - DEBRIDAV_STRM_PROVIDERS=REAL_DEBRID,PREMIUMIZE  # Only these providers use STRM files
      # Optional: Exclude files matching regex pattern from STRM file creation
      # Examples:
      # - DEBRIDAV_STRM_EXCLUDE_FILENAME_REGEX=.*sample.*  # Exclude files containing "sample"
      # - DEBRIDAV_STRM_EXCLUDE_FILENAME_REGEX=.*\\.sample\\.mkv$  # Exclude files ending with ".sample.mkv"
      # Optional: Use external URLs only for specific providers (e.g., IPTV)
      # - DEBRIDAV_STRM_USE_EXTERNAL_URL_FOR_PROVIDERS=IPTV
      # Optional: Use proxy URLs for external URLs (for providers with expiring URLs like PREMIUMIZE)
      # Proxy URLs ensure expired URLs are automatically refreshed when accessed
      # Takes priority over DEBRIDAV_STRM_USE_EXTERNAL_URL_FOR_PROVIDERS
      # Examples:
      #   - DEBRIDAV_STRM_PROXY_EXTERNAL_URL_FOR_PROVIDERS=PREMIUMIZE
      #   - DEBRIDAV_STRM_PROXY_EXTERNAL_URL_FOR_PROVIDERS=PREMIUMIZE,REAL_DEBRID
      #   - DEBRIDAV_STRM_PROXY_EXTERNAL_URL_FOR_PROVIDERS=ALL
      #   - DEBRIDAV_STRM_PROXY_EXTERNAL_URL_FOR_PROVIDERS=*,!IPTV
      # - DEBRIDAV_STRM_PROXY_EXTERNAL_URL_FOR_PROVIDERS=
      # Optional: Base URL for STRM redirect proxy (defaults to detected hostname:8080)
      # Format: http://hostname:port or https://hostname:port
      # Example: - DEBRIDAV_STRM_PROXY_BASE_URL=http://debridav:8080
      # - DEBRIDAV_STRM_PROXY_BASE_URL=
      # Optional: Enable streaming mode for STRM proxy (default: false)
      # If true, content is streamed directly through the proxy instead of redirecting
      # Provides more control over content delivery and better caching/monitoring
      # When false, the proxy redirects to external URLs after verifying/refreshing them
      # When true, the proxy streams content directly using the same logic as VFS files
      # - DEBRIDAV_STRM_PROXY_STREAM_MODE=false

    ports:
      - ${DEBRIDAV_PORT}:8080
      - "8000:8000"
    volumes:
      - ./BigBuckBunny_60fps_1080p.mp4:/local-video/BigBuckBunny_60fps_1080p.mp4
      - ./BigBuckBunny_60fps_720p.mp4:/local-video/BigBuckBunny_60fps_720p.mp4
      - ./iptv_cache:/iptv_cache
      # Legacy storage folder for .debridav files
      #- ${DEBRIDAV_ROOT_HOST_FS}:${DEBRIDAV_ROOT_PATH}
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/actuator/health/readiness" ]
      interval: 2s
      start_period: 2s
      retries: 1000
    depends_on:
      postgres-debridav:
        condition: service_healthy

  # --- First service with ports ---
  rclone:
    <<: *rclone-base
    container_name: rclone
    # https://github.com/peterbuga/docker-services/tree/master/rclone-mount
    ports:
      - "5572:5572"
      - "9002:9002"

  # --- Second service overriding env var and removing ports ---
  rclone_arrs:
    <<: *rclone-base
    container_name: rclone_arrs
    # ports: []  # removes inherited ports
    environment:
      TZ: ${TZ}
      PUID: ${PUID}
      PGID: ${PGID}
      RemotePath: "debridav_arrs:"
      MountPoint: "${DEBRIDAV_MOUNT_PATH_CONTAINERS}_arrs"
      ConfigName: "rclone.conf"
      MountCommands: "--allow-other 
          --allow-non-empty 
          --vfs-cache-mode off 
          --low-level-retries=1
          --dir-cache-time=1s
          -vv
          "
    volumes:
      - ${DEBRIDAV_MOUNT_PATH_HOST_FS}_arrs:${DEBRIDAV_MOUNT_PATH_CONTAINERS}_arrs:rshared
      - ./rclone.conf:/config/rclone.conf

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr-debridav
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./sonarr-config:/config
      - ${DEBRIDAV_MOUNT_PATH_HOST_FS}_arrs:${DEBRIDAV_MOUNT_PATH_CONTAINERS}:rshared
    ports:
      - 8989:8989
    depends_on:
      - rclone_arrs
    restart: unless-stopped

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr-debridav
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./radarr-config:/config
      - ${DEBRIDAV_MOUNT_PATH_HOST_FS}_arrs:${DEBRIDAV_MOUNT_PATH_CONTAINERS}:rshared
    ports:
      - "7878:7878"
    depends_on:
      - rclone_arrs
    restart: unless-stopped

  prowlarr-debridav:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr-debridav
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./prowlarr-config:/config
    ports:
      - "9696:9696"
    restart: unless-stopped

  postgres-debridav:
    image: postgres:17
    container_name: postgres-debridav
    environment:
      - POSTGRES_PASSWORD=debridav
      - POSTGRES_USER=debridav
      - PGDATA=/var/lib/postgresql/data/pgdata
      - PGUSER=debridav
    volumes:
      - ./pgdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready", "-d", "debridav" ]
      interval: 1s
      timeout: 60s
      retries: 10
      start_period: 2s
    restart: unless-stopped

networks:
  default:
    name: debridav
